# 🔍 加点字处理代码详解

## 📋 问题背景
DOCX文件中的加点字格式在XML中表示为 `<w:em w:val="dot"/>`，但Pandoc无法识别这种格式，所以我们需要预处理。

## 🎯 处理策略
将加点字格式转换为Pandoc能识别的下划线+特殊标记格式。

## 📝 代码详解

### 🔍 正则表达式解析
```python
run_with_em_pattern = r'(<w:r>.*?<w:rPr>.*?)<w:em w:val="dot"\s*/>(.*?</w:rPr>.*?<w:t>)(.*?)(</w:t>.*?</w:r>)'
```

这个正则表达式用来匹配DOCX XML中的加点字结构，让我们分解一下：

#### 🏗️ XML结构示例
```xml
<w:r>
    <w:rPr>
        <w:em w:val="dot"/>
        <!-- 其他格式属性 -->
    </w:rPr>
    <w:t>筹</w:t>
</w:r>
```

#### 📊 正则表达式分组
| 分组 | 模式 | 匹配内容 | 示例 |
|------|------|----------|------|
| `group(1)` | `(<w:r>.*?<w:rPr>.*?)` | 从`<w:r>`到`<w:rPr>`的开始部分 | `<w:r><w:rPr>` |
| 固定匹配 | `<w:em w:val="dot"\s*/>` | 加点字标记（不捕获） | `<w:em w:val="dot"/>` |
| `group(2)` | `(.*?</w:rPr>.*?<w:t>)` | 从加点字标记后到文本开始 | `</w:rPr><w:t>` |
| `group(3)` | `(.*?)` | 实际的文字内容 | `筹` |
| `group(4)` | `(</w:t>.*?</w:r>)` | 文本结束到整个run结束 | `</w:t></w:r>` |

### 🔄 替换函数详解
```python
def replace_run_with_em(match):
    before_em = match.group(1)      # <w:r><w:rPr>
    after_em = match.group(2)       # </w:rPr><w:t>
    text_content = match.group(3)   # 筹
    after_text = match.group(4)     # </w:t></w:r>
    
    # 添加下划线和特殊标记
    underline_xml = '<w:u w:val="single"/>'  # 下划线格式
    marked_text = f"[DOT_BELOW]{text_content}[/DOT_BELOW]"  # 特殊标记
    
    return f"{before_em}{underline_xml}{after_em}{marked_text}{after_text}"
```

## 📈 转换过程演示

### 🟥 原始XML
```xml
<w:r>
    <w:rPr>
        <w:em w:val="dot"/>
    </w:rPr>
    <w:t>筹</w:t>
</w:r>
```

### 🟨 分组提取
- `before_em`: `<w:r><w:rPr>`
- 匹配并删除: `<w:em w:val="dot"/>`
- `after_em`: `</w:rPr><w:t>`
- `text_content`: `筹`
- `after_text`: `</w:t></w:r>`

### 🟩 转换后XML
```xml
<w:r>
    <w:rPr>
        <w:u w:val="single"/>
    </w:rPr>
    <w:t>[DOT_BELOW]筹[/DOT_BELOW]</w:t>
</w:r>
```

## 🎯 为什么这样做？

### 1. **保持XML结构完整**
- 不破坏原有的 `<w:r>` (run) 结构
- 保持 `<w:rPr>` (run properties) 和 `<w:t>` (text) 的层次

### 2. **添加Pandoc能识别的格式**
- `<w:u w:val="single"/>` → Pandoc能识别为下划线
- `[DOT_BELOW]...[/DOT_BELOW]` → 我们的特殊标记

### 3. **确保后续转换链条**
```
原始DOCX → 预处理 → Pandoc转换 → LLM处理 → 最终HTML
    ↓           ↓            ↓           ↓
<w:em/>  →  [DOT_BELOW] →  [\[DOT_  →   <span>
             + 下划线      BELOW\]]     加点字
                          {.underline}   HTML
```

## 🧪 完整示例

### 输入文档内容
```
你审核资料中标注的字音。下列加点字读音标注不正确的一项是（ ）
A. 筹（chóu）划  ← 这里的"筹"有加点格式
```

### XML处理过程
1. **原始XML**: `<w:em w:val="dot"/>筹`
2. **预处理后**: `<w:u w:val="single"/>[DOT_BELOW]筹[/DOT_BELOW]`
3. **Pandoc输出**: `[\[DOT_BELOW\]筹\[/DOT_BELOW\]]{.underline}`
4. **LLM转换**: `<span style="text-emphasis: filled dot black; text-emphasis-position: under right;">筹</span>`

## 💡 关键要点

1. **非贪婪匹配** (`.*?`): 确保只匹配最近的结束标签
2. **分组捕获**: 精确提取需要的部分，重新组装
3. **格式转换**: 将无法识别的格式转为可识别的格式
4. **标记系统**: 使用特殊标记在处理链中传递格式信息

这样就实现了从DOCX中的加点字格式到最终HTML加点字格式的完整转换！
